# RoadMap — FruitBot (Telegram + FastAPI + PyTorch + OpenCV)

Ниже — детальный план с более реалистичными сроками для 1 разработчика full-time.
Если работа part-time или требуется деплой/CI, сроки стоит умножить на 1.5–2.

## Предпосылки и допущения
- Один разработчик full-time (40 ч/нед).
- Доступ к GPU необязателен, но ускоряет обучение; CPU допустим.
- Датасет Fruits-360 скачивается один раз и хранится локально.
- Без деплоя/CI/CD (локальный запуск).

## Общая оценка сроков
- 4–6 недель для полноценной реализации с тестированием и стабилизацией.
- Буфер на риски: +20–30%.

---

## Этап 0 — Подготовка и уточнение требований (2–3 дня)
**Цель:** снять риски и подготовить основу для разработки.
**Задачи:**
- Уточнить требования к UX (оформление страниц, формат статистики).
- Зафиксировать формат JSON и структуру каталогов.
- Определить формат логирования и уровни ошибок.
- Принять решение по запуску (uvicorn + aiogram в одном процессе).
- Составить список зависимостей и версий.
**Артефакты:**
- Спецификация форматов JSON и путей.
- Черновой план модулей и их API.

## Этап 1 — Базовый каркас проекта (2–3 дня)
**Цель:** создать минимальный скелет проекта и инфраструктуру.
**Задачи:**
- Развернуть структуру каталогов.
- Создать `requirements.txt`.
- Настроить `core/config.py` (пути, токены, параметры модели).
- Подготовить `main.py` без логики (заглушки запуска).
- Настроить базовый логгер.
**Артефакты:**
- Рабочий каркас с импортируемыми модулями.
- Единая конфигурация приложения.

## Этап 2 — Хранилище JSON и файловая система (4–5 дней)
**Цель:** единый слой хранения для бота и веба.
**Задачи:**
- Реализовать `core/storage.py` (CRUD для JSON).
- Настроить filelock и атомарную запись.
- Реализовать сохранение оригиналов и аннотированных фото.
- Реализовать пагинацию и фильтры для истории.
- Тестирование на конкурентных записях.
**Артефакты:**
- Полноценный storage-слой.
- Проверенные JSON-файлы с валидной структурой.

## Этап 3 — Подготовка датасета (2–3 дня)
**Цель:** подготовить данные для обучения.
**Задачи:**
- Скачать Fruits-360, проверить целостность.
- Отфильтровать категории Apple* и Orange.
- Сформировать единый бинарный датасет.
- Провести sanity-check изображений.
- Описать процесс подготовки в README.
**Артефакты:**
- Подготовленный датасет.
- Документация подготовки.

## Этап 4 — Обучение модели (4–6 дней)
**Цель:** получить рабочую модель ResNet18.
**Задачи:**
- Реализовать `train.py` (transforms, dataloaders).
- Настроить resnet18 + замена последнего слоя.
- Реализовать метрики и сохранение лучшей модели.
- Провести 5–10 эпох и оценить accuracy.
- Зафиксировать параметры и логи обучения.
**Артефакты:**
- `model.pth` с валидной точностью.
- Логи/отчёт обучения.

## Этап 5 — Инференс и обработка изображений (3–4 дня)
**Цель:** единый pipeline инференса.
**Задачи:**
- Реализовать `core/model.py` (загрузка модели, инференс).
- Реализовать `core/processor.py` (OpenCV: resize, normalize).
- Добавить отрисовку класса и confidence.
- Измерение времени обработки и сохранение результата.
- Тестирование на наборе изображений.
**Артефакты:**
- Стабильный pipeline инференса.
- Аннотированные изображения.

## Этап 6 — FastAPI API слой (4–5 дней)
**Цель:** API для веб-интерфейса.
**Задачи:**
- Реализовать `GET /api/history` с пагинацией.
- Реализовать `GET /api/analysis/{id}`.
- Реализовать `POST /api/upload`.
- Подключить storage и processor.
- Добавить валидацию форматов и ошибок.
**Артефакты:**
- Рабочий REST API.
- Документация эндпойнтов.

## Этап 7 — Веб-интерфейс (5–7 дней)
**Цель:** полноценные страницы и UI.
**Задачи:**
- Главная `/` (список последних результатов).
- `/analysis/{id}` (детальный просмотр).
- `/stats` (Chart.js + сводная статистика).
- `/upload` (форма загрузки).
- Единый стиль и адаптивная верстка.
**Артефакты:**
- Полный web UI.
- Статика (CSS/JS).

## Этап 8 — Telegram-бот (4–6 дней)
**Цель:** реализовать все команды и сценарии.
**Задачи:**
- `/start`, `/help`, `/stats`, `/history`.
- Обработка фото с валидацией формата.
- Интеграция processor + storage.
- Отправка аннотированного фото.
- Проверка на больших изображениях.
**Артефакты:**
- Рабочий бот со всеми командами.

## Этап 9 — Интеграция и совместный запуск (3–4 дня)
**Цель:** единый запуск FastAPI и Aiogram.
**Задачи:**
- Организация asyncio-цикла.
- Корректное завершение приложения.
- Проверка коллизий в доступе к JSON.
- Нагрузочный тест (серия загрузок).
**Артефакты:**
- Единый запуск `main.py`.

## Этап 10 — Тестирование и стабилизация (5–7 дней)
**Цель:** обнаружить и исправить дефекты.
**Задачи:**
- Интеграционные тесты API и бота.
- Проверка JSON целостности.
- Проверка производительности и ошибок.
- Улучшение обработки исключений.
- Регрессионное тестирование.
**Артефакты:**
- Устойчивое поведение системы.

## Этап 11 — Документация и полировка (3–4 дня)
**Цель:** сделать проект готовым к сдаче.
**Задачи:**
- Обновить README с инструкциями запуска.
- Добавить описание структуры данных.
- Описать шаги обучения модели.
- Добавить примеры запросов API.
- Финальная проверка зависимостей.
**Артефакты:**
- Полная документация.

---

## Контрольные точки
1. **M1:** Storage готов и проверен (конец Этапа 2).
2. **M2:** Модель обучена и инференс работает (конец Этапа 5).
3. **M3:** API и Web готовы (конец Этапа 7).
4. **M4:** Бот полностью готов (конец Этапа 8).
5. **M5:** Интеграция и стабилизация завершены (конец Этапа 10).

## Риски и буферы
- Скачивание и подготовка датасета может занять больше времени.
- На CPU обучение может растянуться на 1–2 дня.
- Параллельная запись JSON без блокировок приводит к порче данных — критично соблюдать filelock.
- UX-работы на веб-интерфейсе могут потребовать дополнительных правок.

## Итоговая оценка
- **Минимум:** ~4 недели (без задержек, опытный разработчик).
- **Реалистично:** **5–6 недель** с учетом тестирования и буфера.
